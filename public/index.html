<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode Two-Sum å®æ—¶åœ¨çº¿äººæ•°ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 0.95em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card.us {
            background: linear-gradient(135deg, #5470C6 0%, #3b5999 100%);
        }

        .stat-card.cn {
            background: linear-gradient(135deg, #91CC75 0%, #73a855 100%);
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-time {
            font-size: 0.75em;
            opacity: 0.8;
            margin-top: 8px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
        }

        button {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button.active {
            background: #667eea;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #chart {
            width: 100%;
            height: 600px;
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            color: #999;
            font-size: 0.85em;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fcc;
        }

        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #90caf9;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            #chart {
                height: 400px;
            }

            .stat-value {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š LeetCode Two-Sum åœ¨çº¿äººæ•°ç›‘æ§</h1>
            <p class="subtitle">å®æ—¶è¿½è¸ªå…¨çƒæœ€çƒ­é—¨ç®—æ³•é¢˜çš„åˆ·é¢˜äººæ•°</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card us">
                <div class="stat-label">ğŸŒ å›½é™…åŒº (US)</div>
                <div class="stat-value" id="us-count">--</div>
                <div class="stat-time" id="us-time">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card cn">
                <div class="stat-label">ğŸ‡¨ğŸ‡³ ä¸­å›½åŒº (CN)</div>
                <div class="stat-value" id="cn-count">--</div>
                <div class="stat-time" id="cn-time">åŠ è½½ä¸­...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ˆ æ•°æ®ç‚¹æ•°</div>
                <div class="stat-value" id="data-points">--</div>
                <div class="stat-time" id="update-time">ç­‰å¾…æ›´æ–°</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <span class="control-label">æ—¶é—´ç²’åº¦ï¼š</span>
                <button onclick="setGranularity('fivemin')" id="btn-fivemin">æŒ‰ 5 åˆ†é’Ÿ</button>
                <button onclick="setGranularity('halfhour')" id="btn-halfhour">æŒ‰åŠå°æ—¶</button>
                <button onclick="setGranularity('hour')" id="btn-hour" class="active">æŒ‰å°æ—¶</button>
                <button onclick="setGranularity('day')" id="btn-day">æŒ‰å¤©</button>
                <button onclick="setGranularity('month')" id="btn-month">æŒ‰æœˆ</button>
            </div>
            <div class="control-group">
                <button onclick="fetchData()" id="btn-refresh">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>

        <div id="message"></div>
        <div id="chart"></div>

        <div class="footer">
            <p>æ•°æ®æ¯åˆ†é’Ÿè‡ªåŠ¨é‡‡é›† | Powered by Cloudflare Workers + D1 + Pages</p>
            <p>é¡¹ç›®å¼€æºäº GitHub</p>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8787'
            : 'https://two-sum.two-sum.workers.dev';

        let chart;
        let currentGranularity = 'hour';
        let autoRefreshInterval;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            chart = echarts.init(document.getElementById('chart'));
            window.addEventListener('resize', () => chart.resize());

            // é¦–æ¬¡åŠ è½½
            fetchData();
            fetchLatest();

            // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ 60 ç§’ï¼‰
            autoRefreshInterval = setInterval(() => {
                fetchData();
                fetchLatest();
            }, 60000);
        });

        // è®¾ç½®æ—¶é—´ç²’åº¦
        function setGranularity(granularity) {
            currentGranularity = granularity;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.control-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${granularity}`).classList.add('active');

            fetchData();
        }

        // è·å–æœ€æ–°æ•°æ®
        async function fetchLatest() {
            try {
                const res = await fetch(`${API_URL}/api/latest`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                if (data.US) {
                    document.getElementById('us-count').textContent = data.US.count.toLocaleString();
                    document.getElementById('us-time').textContent = formatTime(data.US.timestamp);
                } else {
                    document.getElementById('us-count').textContent = 'æš‚æ— ';
                    document.getElementById('us-time').textContent = 'é‡‡é›†å¤±è´¥';
                }

                if (data.CN) {
                    document.getElementById('cn-count').textContent = data.CN.count.toLocaleString();
                    document.getElementById('cn-time').textContent = formatTime(data.CN.timestamp);
                } else {
                    document.getElementById('cn-count').textContent = 'æš‚æ— ';
                    document.getElementById('cn-time').textContent = 'ç­‰å¾…æ•°æ®';
                }

            } catch (error) {
                console.error('Error fetching latest:', error);
            }
        }

        // è·å–å†å²æ•°æ®
        async function fetchData() {
            const btn = document.getElementById('btn-refresh');
            btn.disabled = true;
            btn.textContent = 'â³ åŠ è½½ä¸­...';

            chart.showLoading({
                text: 'åŠ è½½æ•°æ®ä¸­...',
                color: '#667eea',
                textColor: '#000',
                maskColor: 'rgba(255, 255, 255, 0.8)'
            });

            document.getElementById('message').innerHTML = '';

            try {
                // æ ¹æ®ç²’åº¦è®¾ç½®é™åˆ¶
                let limit;
                switch (currentGranularity) {
                    case 'fivemin':
                        limit = 288; // 24 å°æ—¶ * 12ï¼ˆæ¯å°æ—¶12ä¸ª5åˆ†é’Ÿï¼‰
                        break;
                    case 'halfhour':
                        limit = 336; // 7 å¤© * 24 å°æ—¶ * 2ï¼ˆæ¯å°æ—¶2ä¸ªåŠå°æ—¶ï¼‰
                        break;
                    case 'hour':
                        limit = 168; // 7 å¤© * 24 å°æ—¶
                        break;
                    case 'day':
                        limit = 90; // 90 å¤©
                        break;
                    case 'month':
                        limit = 24; // 24 ä¸ªæœˆ
                        break;
                }

                const res = await fetch(`${API_URL}/api/aggregated?granularity=${currentGranularity}&limit=${limit}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    showMessage('æš‚æ— æ•°æ®ï¼Œè¯·ç­‰å¾…æ•°æ®é‡‡é›†...', 'info');
                    chart.hideLoading();
                    return;
                }

                renderChart(data);

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('data-points').textContent = data.length.toLocaleString();
                document.getElementById('update-time').textContent = 'åˆšåˆšæ›´æ–°';

            } catch (error) {
                console.error('Error fetching data:', error);
                showMessage(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            } finally {
                chart.hideLoading();
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ åˆ·æ–°';
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(data) {
            // æ•°æ®åˆ†ç»„
            const usData = data.filter(d => d.region === 'US');
            const cnData = data.filter(d => d.region === 'CN');

            // æå–æ—¶é—´è½´ï¼Œä½¿ç”¨ä¸­å›½æ—¶åŒºæ ¼å¼åŒ–
            const baseData = usData.length >= cnData.length ? usData : cnData;
            const times = baseData.map(d => {
                // å°† time å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºæ˜¾ç¤º
                // API è¿”å›çš„ time æ˜¯ UTC æ—¶é—´ï¼Œéœ€è¦è½¬æ¢ä¸º UTC+8
                return d.time; // API å·²ç»è¿”å›æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            });

            // è·å–ç²’åº¦æ ‡é¢˜
            let granularityTitle;
            switch (currentGranularity) {
                case 'fivemin':
                    granularityTitle = 'æŒ‰ 5 åˆ†é’Ÿ';
                    break;
                case 'halfhour':
                    granularityTitle = 'æŒ‰åŠå°æ—¶';
                    break;
                case 'hour':
                    granularityTitle = 'æŒ‰å°æ—¶';
                    break;
                case 'day':
                    granularityTitle = 'æŒ‰å¤©';
                    break;
                case 'month':
                    granularityTitle = 'æŒ‰æœˆ';
                    break;
            }

            // é…ç½®å›¾è¡¨
            const option = {
                title: {
                    text: `LeetCode Two-Sum åœ¨çº¿äººæ•°è¶‹åŠ¿ï¼ˆ${granularityTitle}ï¼‰`,
                    left: 'center',
                    textStyle: { fontSize: 16 }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let html = `<strong>${params[0].axisValue}</strong><br/>`;
                        params.forEach(item => {
                            const dataItem = item.seriesName.includes('US') ?
                                usData.find(d => d.time === item.axisValue) :
                                cnData.find(d => d.time === item.axisValue);

                            if (dataItem) {
                                html += `${item.marker} ${item.seriesName}: <strong>${Math.round(item.value)}</strong> äºº<br/>`;
                                html += `<span style="color:#999;font-size:12px">  â”” èŒƒå›´: ${dataItem.min_count} - ${dataItem.max_count}</span><br/>`;
                            }
                        });
                        return html;
                    }
                },
                legend: {
                    data: ['å›½é™…åŒº (US)', 'ä¸­å›½åŒº (CN)'],
                    top: 35
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                dataZoom: [
                    {
                        type: 'slider',
                        start: 0,
                        end: 100,
                        height: 20,
                        bottom: 30
                    },
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    }
                ],
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(times.length / 10) || 0
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'å›½é™…åŒºäººæ•°',
                        position: 'left',
                        scale: true,
                        axisLine: {
                            show: true,
                            lineStyle: { color: '#5470C6' }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        },
                        splitLine: {
                            lineStyle: { type: 'dashed' }
                        }
                    },
                    {
                        type: 'value',
                        name: 'ä¸­å›½åŒºäººæ•°',
                        position: 'right',
                        scale: true,
                        axisLine: {
                            show: true,
                            lineStyle: { color: '#91CC75' }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        },
                        splitLine: { show: false }
                    }
                ],
                series: [
                    {
                        name: 'å›½é™…åŒº (US)',
                        type: 'line',
                        yAxisIndex: 0,
                        data: usData.map(d => Math.round(d.avg_count)),
                        showSymbol: false,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#5470C6'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(84, 112, 198, 0.4)' },
                                { offset: 1, color: 'rgba(84, 112, 198, 0.1)' }
                            ])
                        }
                    },
                    {
                        name: 'ä¸­å›½åŒº (CN)',
                        type: 'line',
                        yAxisIndex: 1,
                        data: cnData.map(d => Math.round(d.avg_count)),
                        showSymbol: false,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#91CC75'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(145, 204, 117, 0.4)' },
                                { offset: 1, color: 'rgba(145, 204, 117, 0.1)' }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option, true);
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆä¸­å›½æ—¶åŒº UTC+8ï¼‰
        function formatTime(timestamp) {
            // åˆ›å»ºä¸­å›½æ—¶åŒºçš„æ—¥æœŸå¯¹è±¡
            const date = new Date(timestamp);

            // è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰
            const chinaTime = new Date(date.getTime() + (8 * 60 * 60 * 1000) - (date.getTimezoneOffset() * 60 * 1000));

            const month = String(chinaTime.getUTCMonth() + 1).padStart(2, '0');
            const day = String(chinaTime.getUTCDate()).padStart(2, '0');
            const hours = String(chinaTime.getUTCHours()).padStart(2, '0');
            const minutes = String(chinaTime.getUTCMinutes()).padStart(2, '0');
            return `${month}-${day} ${hours}:${minutes}`;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const className = type === 'error' ? 'error' : 'info';
            document.getElementById('message').innerHTML =
                `<div class="${className}">${message}</div>`;
        }
    </script>
</body>
</html>
